<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMCL - Logic Puzzle Clue Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .container-fluid { max-width: 1400px; }
        .puzzle-input { height: 300px; }
        .asp-output { height: 400px; }
        .solution-output { height: 200px; }
        .loading { display: none; }
        .spinner-border { width: 1rem; height: 1rem; }
        .results-section { display: none; }
        .error-alert { display: none; }
        .badge-success { background-color: #28a745; }
        .badge-danger { background-color: #dc3545; }
        .badge-warning { background-color: #ffc107; color: #212529; }
        pre { background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; }
        .model-help { font-size: 0.875em; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4 text-center mb-3">
                    üß© LLMCL
                    <small class="text-muted fs-6">Logic Puzzle Clue Extractor</small>
                </h1>
                <p class="text-center text-muted">
                    Extract ASP facts from natural language puzzle descriptions using LLMs
                </p>
            </div>
        </div>

        <!-- Main Form -->
        <form id="puzzleForm">
            <div class="row">
                <!-- Input Section -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üìù Puzzle Input</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="puzzle_text" class="form-label">Puzzle Description (JSON or Plain Text)</label>
                                <textarea 
                                    class="form-control puzzle-input font-monospace" 
                                    id="puzzle_text" 
                                    name="puzzle_text" 
                                    placeholder="Enter your logic puzzle description here..."
                                    required>{{ sample_puzzle }}</textarea>
                                <div class="form-text">
                                    You can input either structured JSON (as shown) or plain text description.
                                </div>
                            </div>

                            <!-- Model Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="model" class="form-label">ü§ñ LLM Model</label>
                                    <select class="form-select" id="model" name="model">
                                        <optgroup label="OpenAI Models">
                                            <option value="gpt-4" selected>GPT-4 (Recommended)</option>
                                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                                        </optgroup>
                                        <optgroup label="Anthropic Models">
                                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Excellent)</option>
                                            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fast)</option>
                                            <option value="claude-3-opus-20240229">Claude 3 Opus (Premium)</option>
                                        </optgroup>
                                    </select>
                                    <div class="model-help">
                                        OpenAI models need OPENAI_API_KEY, Claude models need ANTHROPIC_API_KEY
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="api_key" class="form-label">üîë API Key (Optional)</label>
                                    <input 
                                        type="password" 
                                        class="form-control" 
                                        id="api_key" 
                                        name="api_key"
                                        placeholder="Leave empty to use env variables">
                                    <div class="form-text">
                                        Override environment variable if needed
                                    </div>
                                </div>
                            </div>

                            <!-- Options -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="verbose" name="verbose">
                                    <label class="form-check-label" for="verbose">
                                        Enable verbose output
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="force_derive" name="force_derive">
                                    <label class="form-check-label" for="force_derive">
                                        Force-derive missing values (deep reasoning mode)
                                    </label>
                                    <div class="form-text">
                                        Uses advanced reasoning to derive exact values instead of placeholders
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <span class="loading">
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    Processing...
                                </span>
                                <span class="not-loading">
                                    üöÄ Extract Clues & Solve Puzzle
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">üìä Results</h5>
                            <div id="statusBadges"></div>
                        </div>
                        <div class="card-body">
                            <!-- Error Display -->
                            <div id="errorAlert" class="alert alert-danger error-alert">
                                <h6>‚ùå Error</h6>
                                <div id="errorMessage"></div>
                            </div>

                            <!-- Results Tabs -->
                            <div id="resultsSection" class="results-section">
                                <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="asp-tab" data-bs-toggle="tab" data-bs-target="#asp" type="button" role="tab">ASP Facts</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="solution-tab" data-bs-toggle="tab" data-bs-target="#solution" type="button" role="tab">Solution</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure" type="button" role="tab">Structure</button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content mt-3" id="resultsTabContent">
                                    <!-- ASP Facts Tab -->
                                    <div class="tab-pane fade show active" id="asp" role="tabpanel">
                                        <h6>Generated ASP Facts:</h6>
                                        <pre id="aspFacts" class="asp-output"></pre>
                                        <div id="syntaxErrors" class="mt-2"></div>
                                    </div>
                                    
                                    <!-- Solution Tab -->
                                    <div class="tab-pane fade" id="solution" role="tabpanel">
                                        <h6>Puzzle Solution:</h6>
                                        <div id="solutionStatus" class="mb-2"></div>
                                        <pre id="solutionOutput" class="solution-output"></pre>
                                        <div id="solutionFacts" class="mt-2"></div>
                                    </div>
                                    
                                    <!-- Structure Tab -->
                                    <div class="tab-pane fade" id="structure" role="tabpanel">
                                        <h6>Extracted Structure:</h6>
                                        <pre id="structureInfo"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Initial Help Text -->
                            <div id="helpText" class="text-center text-muted py-5">
                                <p class="lead">üëÜ Fill in your puzzle above and click "Extract Clues & Solve Puzzle" to see the results here.</p>
                                <p>The sample puzzle is already loaded to get you started!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-3 bg-light">
        <div class="container-fluid text-center text-muted">
            <p class="mb-0">LLMCL - Logic Puzzle Clue Extractor | Built with Flask & Bootstrap</p>
            <small>Supports OpenAI GPT and Anthropic Claude models</small>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Form submission handling
        document.getElementById('puzzleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            document.querySelector('.loading').style.display = 'inline';
            document.querySelector('.not-loading').style.display = 'none';
            document.getElementById('helpText').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Get form data
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showError(result.error);
                } else {
                    showResults(result);
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                // Hide loading state
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.not-loading').style.display = 'inline';
            }
        });
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'block';
        }
        
        function showResults(result) {
            // Update status badges
            const badges = document.getElementById('statusBadges');
            badges.innerHTML = `
                <span class="badge ${result.syntax_valid ? 'badge-success' : 'badge-danger'} me-1">
                    ${result.syntax_valid ? '‚úÖ Syntax OK' : '‚ùå Syntax Errors'}
                </span>
                <span class="badge ${result.solution_success ? 'badge-success' : 'badge-warning'} me-1">
                    ${result.solution_success ? 'üéâ Solved' : '‚ö†Ô∏è No Solution'}
                </span>
                <span class="badge bg-info text-dark">
                    ü§ñ ${result.provider} - ${result.model_used}
                </span>
            `;
            
            // Show ASP facts
            document.getElementById('aspFacts').textContent = result.asp_facts;
            
            // Show syntax errors if any
            const syntaxErrorsDiv = document.getElementById('syntaxErrors');
            if (result.syntax_errors && result.syntax_errors.length > 0) {
                syntaxErrorsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è Syntax Issues:</h6>
                        <ul class="mb-0">
                            ${result.syntax_errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                syntaxErrorsDiv.innerHTML = '';
            }
            
            // Show solution
            const solutionStatusDiv = document.getElementById('solutionStatus');
            if (result.solution_success) {
                solutionStatusDiv.innerHTML = '<div class="alert alert-success">üéâ Puzzle solved successfully!</div>';
                
                // Use formatted solutions if available, otherwise fall back to raw facts
                if (result.formatted_solutions) {
                    document.getElementById('solutionFacts').innerHTML = `
                        <pre style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 14px; line-height: 1.4;">${result.formatted_solutions}</pre>
                    `;
                } else if (result.solution_facts && result.solution_facts.length > 0) {
                    const factsByPredicate = {};
                    result.solution_facts.forEach(fact => {
                        const predicate = fact.split('(')[0];
                        if (!factsByPredicate[predicate]) {
                            factsByPredicate[predicate] = [];
                        }
                        factsByPredicate[predicate].push(fact);
                    });
                    
                    let formattedSolution = '';
                    Object.keys(factsByPredicate).sort().forEach(predicate => {
                        formattedSolution += `\n${predicate.toUpperCase()}:\n`;
                        factsByPredicate[predicate].forEach(fact => {
                            formattedSolution += `  ${fact}\n`;
                        });
                    });
                    
                    document.getElementById('solutionFacts').innerHTML = `
                        <h6>Solution Facts:</h6>
                        <pre>${formattedSolution}</pre>
                    `;
                }
            } else {
                solutionStatusDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Could not solve puzzle</div>';
                document.getElementById('solutionFacts').innerHTML = '';
            }
            
            document.getElementById('solutionOutput').textContent = result.solution_output;
            
            // Show structure
            document.getElementById('structureInfo').textContent = JSON.stringify(result.structured_info, null, 2);
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        // Initialize syntax highlighting
        hljs.highlightAll();
    </script>
</body>
</html> 